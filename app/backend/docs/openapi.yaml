openapi: 3.0.3

info:
  title: PagFlow
  description: |
    API-first payment platform for one-time payments.
    Focused on payments, webhooks, idempotency and security.
  version: 1.0.0
  contact:
    name: Danilo Tech
    email: contato@danilotech.dev

servers:
  - url: http://localhost:4000
    description: Local development
  - url: https://api.staging.payment-platform.dev
    description: Staging
  - url: https://api.payment-platform.dev
    description: Production

tags:
  - name: Auth
  - name: Products
  - name: Orders
  - name: Payments
  - name: Webhooks
  - name: Health

paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Customer created
        "400":
          description: Validation error

  /auth/login:
    post:
      tags: [Auth]
      summary: Login customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokens"
        "401":
          description: Invalid credentials

  /products:
    get:
      tags: [Products]
      summary: List products
      responses:
        "200":
          description: Product list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Product"

  /products/{id}:
    get:
      tags: [Products]
      summary: Get product details
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Product detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "404":
          description: Product not found

  /orders:
    post:
      tags: [Orders]
      summary: Create order
      security:
        - BearerAuth: []
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOrderRequest"
      responses:
        "201":
          description: Order created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "401":
          description: Unauthorized

    get:
      tags: [Orders]
      summary: List customer orders
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Orders list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Order"

  /orders/{id}:
    get:
      tags: [Orders]
      summary: Get order detail
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Order detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "404":
          description: Order not found

  /payments:
    post:
      tags: [Payments]
      summary: Create payment
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePaymentRequest"
      responses:
        "200":
          description: Payment created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Payment"

  /webhooks/payment:
    post:
      tags: [Webhooks]
      summary: Receive payment webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebhookEvent"
      responses:
        "200":
          description: Webhook processed

  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: API is healthy

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    RegisterRequest:
      type: object
      required: [name, email, password]
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        password:
          type: string

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthTokens:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string

    Product:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        price_cents:
          type: integer
        currency:
          type: string

    CreateOrderRequest:
      type: object
      required: [productId]
      properties:
        productId:
          type: integer

    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
        productId:
          type: integer
        amount_cents:
          type: integer
        status:
          type: string
          enum: [PENDING, PAID, FAILED]
        created_at:
          type: string
          format: date-time

    CreatePaymentRequest:
      type: object
      required: [orderId, paymentMethod]
      properties:
        orderId:
          type: string
          format: uuid
        paymentMethod:
          type: string
          enum: [CARD, PIX]
        card:
          type: object
          properties:
            number:
              type: string
            exp:
              type: string
            cvv:
              type: string

    Payment:
      type: object
      properties:
        paymentId:
          type: string
          format: uuid
        status:
          type: string
          enum: [PENDING, SUCCESS, FAILED]

    WebhookEvent:
      type: object
      required: [event_id, order_id, payment_id, status]
      properties:
        event_id:
          type: string
        order_id:
          type: string
          format: uuid
        payment_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [SUCCESS, FAILED]
